# 独立任务队列架构说明

## 概述

本系统采用双队列架构，将头条文章转发和YouTube视频下载任务完全分离，确保两个功能互不干扰。

## 任务队列架构

### 1. 头条任务队列 (toutiao_task_queue)
- **用途**: 专门处理头条文章转发任务
- **容量**: 最大50个任务
- **处理器**: `toutiao_task_worker()`
- **任务类型**: `toutiao_forward`

### 2. YouTube任务队列 (youtube_task_queue)
- **用途**: 处理YouTube视频下载任务
- **容量**: 最大50个任务
- **处理器**: `youtube_task_worker()`
- **任务类型**: `youtube_download`

## 接口说明

### 头条相关接口
- `POST /api/toutiao/forward` - 头条文章转发
- `GET /api/toutiao/accounts` - 获取头条账号列表

### YouTube相关接口
- `POST /api/youtube/download` - YouTube视频下载

### 任务状态查询接口
- `GET /api/task/{task_id}` - 查询单个任务状态
- `GET /api/tasks/logs` - 查看所有任务日志

## 优势

1. **独立性**: 头条和YouTube任务完全独立，互不干扰
2. **可扩展性**: 每个队列可以独立调整容量和处理策略
3. **监控性**: 可以分别监控两个队列的状态和性能
4. **容错性**: 一个队列出现问题不会影响另一个队列
5. **简洁性**: 接口设计简洁明了，易于使用和维护

## 任务处理流程

### 头条任务处理流程
1. 接收头条转发请求
2. 生成任务ID并加入 `toutiao_task_queue`
3. `toutiao_task_worker` 从队列获取任务
4. 调用头条转发脚本处理
5. 更新任务状态和结果

### YouTube任务处理流程
1. 接收YouTube下载请求
2. 生成任务ID并加入 `youtube_task_queue`
3. `youtube_task_worker` 从队列获取任务
4. 调用YouTube下载脚本处理
5. 更新任务状态和结果

## 监控和日志

- 所有任务状态统一存储在 `task_status` 字典中
- 每个任务包含创建时间、完成时间、状态、消息等信息
- 支持实时监控队列状态

## 测试

使用 `test_independent_queues.py` 脚本可以测试两个独立队列的功能：

```bash
python3 test_independent_queues.py
```

该脚本会测试：
- 头条任务队列
- YouTube下载队列
- 队列日志查询功能

## 接口示例

### 头条文章转发
```bash
curl -X POST "http://localhost:8000/api/toutiao/forward" \
  -H "Content-Type: application/json" \
  -d '{
    "urls": ["https://juejin.cn/post/7509755785611952180"],
    "save_file": false,
    "account_file": "cookiesFile/toutiao_cookie.json",
    "use_ai": false,
    "default_tags": ["AI", "互联网", "自动化"]
  }'
```

### YouTube视频下载
```bash
curl -X POST "http://localhost:8000/api/youtube/download" \
  -H "Content-Type: application/json" \
  -d '{
    "url": ["https://www.youtube.com/watch?v=TyrCvZlhF68"],
    "quality": "best",
    "output_dir": "videos"
  }'
```

### 查询任务状态
```bash
curl "http://localhost:8000/api/task/{task_id}"
```

### 查看所有任务日志
```bash
curl "http://localhost:8000/api/tasks/logs"
``` 